<!DOCTYPE html>
<meta charset="utf-8">
<style>
.node circle {
  stroke: #fff;
  stroke-width: 1px;
}
</style>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<div class="ui-widget">
   <input id="search">
    <button type="button" onclick="searchNode()">Search</button>
</div>

<svg width="800" height="900"></svg>

<script>
var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

var simulation = d3.forceSimulation()
    .force("link", d3.forceLink()
      .id(function(d) { return d.id; })
      .strength(function(link) { return link.value })
      .distance(60)
    )
    .force("charge", d3.forceManyBody()
      .strength(-25)
    )
    .force("center", d3.forceCenter(width / 2, height / 2));

var color = d3.scaleSequential(d3.interpolatePRGn).domain([1, 25])

var nodeColor = function(d) {
  if (d.media_index === 0) {
    return 'grey';
  } else {
    return color(d.media_index);
  }
}

d3.json("outgroup.json", function(error, graph) {
  if (error) throw error;

  svg.style("pointer-events", "all")
  .call(d3.zoom()
    .scaleExtent([1 / 2, 4])
    .on("zoom", zoomed))
  .on("dblclick.zoom", null);

  var g = svg.append("g");

  function zoomed() {
    g.attr("transform", d3.event.transform);
  }

  var node = g
    .selectAll(".node")
    .data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
    .on("dblclick", connectedNodes);

  svg.on("click", function() {
    if (toggle == 1) {
      node.style("opacity", 1);
      toggle = 0;
    }
  });

  node.append("circle")
      .attr("r", 5)
      .attr("fill", nodeColor);

  node.append("title")
    .text(function(d) { return d.id + ', ' + d.media });

  simulation
    .nodes(graph.nodes)
    .on("tick", ticked);

  simulation.force("link")
    .links(graph.links);

  function ticked() {
    node
        .attr("transform", function(d) {
          return "translate(" + d.x + "," + d.y + ")";
        });
  }

  //Toggle stores whether the highlighting is on
  var toggle = 0;

  //Create an array logging what is connected to what
  var linkedByIndex = {};
  for (i = 0; i < graph.nodes.length; i++) {
      linkedByIndex[i + "," + i] = 1;
  };
  graph.links.forEach(function (d) {
      linkedByIndex[d.source.index + "," + d.target.index] = 1;
  });

  //This function looks up whether a pair are neighbours
  function neighboring(a, b) {
      return linkedByIndex[a.index + "," + b.index];
  }

  function connectedNodes() {
    if (toggle == 0) {
        //Reduce the opacity of all but the neighbouring nodes
        d = d3.select(this).node().__data__;
        node.style("opacity", function (o) {
            return neighboring(d, o) | neighboring(o, d) ? 1 : 0.1;
        });
        toggle = 1;
    } else {
        node.style("opacity", 1);
        toggle = 0;
    }
  }

  var optArray = [];
  for (var i = 0; i < graph.nodes.length - 1; i++) {
      optArray.push(graph.nodes[i].id);
  }
  optArray = optArray.sort();
  $(function () {
      $("#search").autocomplete({
          source: optArray
      });
  });
});

function searchNode() {
  var selectedVal = document.getElementById("search").value;
  var node = svg.selectAll(".node");
  if (selectedVal == "none") {
      node.style("stroke", "white").style("stroke-width", "1");
  } else {
      var selected = node.filter(function (d, i) {
          return d.id != selectedVal;
      });
      selected.style("opacity", "0");
      d3.selectAll(".node").transition()
          .duration(5000)
          .style("opacity", 1);
  }
}
</script>
