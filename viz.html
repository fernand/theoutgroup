<!DOCTYPE html>
<meta charset="utf-8">
<style>

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

.node circle {
  stroke: #fff;
  stroke-width: 1px;
}

.node text {
  fill: #000;
  font: 10px sans-serif;
  pointer-events: none;
}

.lasso path {
  stroke: rgb(80,80,80);
  stroke-width:2px;
}

.lasso .drawn {
  fill-opacity:.05 ;
}

.lasso .loop_close {
  fill:none;
  stroke-dasharray: 4,4;
}

.lasso .origin {
  fill:#3399FF;
  fill-opacity:.5;
}

</style>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src = "./d3-lasso.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

<div class="ui-widget">
   <input id="search">
    <button type="button" onclick="searchNode()">Search</button>
</div>

<!-- <svg width="1200" height="700"></svg> -->
<svg width="1800" height="1000"></svg>

<script>

var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

var color = d3.scaleOrdinal(d3.schemeCategory20);

var simulation = d3.forceSimulation()
    .force("link", d3.forceLink()
      .id(function(d) { return d.id; })
      .strength(function(link) { return link.value })
      // .distance(90)
      .distance(150)
    )
    .force("charge", d3.forceManyBody()
      .strength(-15)
    )
    .force("center", d3.forceCenter(width / 2, height / 2));

var nodeColor = function(d) {
  if (d.color === 0) {
    return color(0);
  } else {
    return "orange";
  }
}

// Lasso functions
var lasso_start = function() {
  lasso.items()
    .classed("not_possible", true)
    .classed("selected", false)
    .select("circle")
    .attr("fill", nodeColor);
};

var lasso_draw = function() {
  // Style the possible dots
  lasso.possibleItems()
    .classed("not_possible", false)
    .classed("possible", true);

  // Style the not possible dot
  lasso.notPossibleItems()
    .classed("not_possible", true)
    .classed("possible", false);
};

var lasso_end = function() {
  // Reset the color of all dots
  lasso.items()
    .classed("not_possible", false)
    .classed("possible", false);

  // Style the selected dots
  lasso.selectedItems()
    .classed("selected", true)
    .select("circle")
    .attr("fill", "green");

  // Reset the style of the not selected dots
  lasso.notSelectedItems()
    .select("circle")
    .attr("fill", nodeColor);

  postData();
};

// Init the lasso on the svg:g that contains the dots
var lasso = d3.lasso()
  .closePathSelect(true)
  .closePathDistance(100)
  .targetArea(svg)
  .on("start", lasso_start)
  .on("draw", lasso_draw)
  .on("end", lasso_end);
svg.call(lasso);

d3.json("outgroup.json", function(error, graph) {
  if (error) throw error;

  svg.style("pointer-events", "all")
  .call(d3.zoom()
    .scaleExtent([1 / 2, 4])
    .on("zoom", zoomed))
  .on("dblclick.zoom", null)
  .on("mousedown.zoom", null)
  .on("touchstart.zoom", null)
  .on("touchmove.zoom", null)
  .on("touchend.zoom", null);

  var g = svg.append("g");

  function zoomed() {
    g.attr("transform", d3.event.transform);
  }

  var node = g
    .selectAll(".node")
    .data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
    .on("dblclick", connectedNodes);

  lasso.items(d3.selectAll(".node"));

  // var link = g
  //     .attr("class", "links")
  //   .selectAll("line")
  //   .data(graph.links)
  //   .enter().append("line")
  //     .attr("stroke-width", function(d) { return Math.sqrt(d.value); });

  svg.on("click", function() {
    if (toggle == 1) {
      node.style("opacity", 1);
      toggle = 0;
    }
  });

  node.append("circle")
      .attr("r", 5)
      .attr("fill", nodeColor);

  node.append("text")
      .attr("dx", 10)
      .attr("dy", ".35em")
    .text(function(d) { return d.id; });

  node.append("title")
    .text(function(d) {
      var t = "";
      for (let f of d.friends) {
        if (t.length !== 0) {
          t += ",";
        }
        t += f;
      }
      t += ';'+d.id;
      return t;
    });

  simulation
    .nodes(graph.nodes)
    .on("tick", ticked);

  simulation.force("link")
    .links(graph.links);

  function ticked() {
    // link
    //     .attr("x1", function(d) { return d.source.x; })
    //     .attr("y1", function(d) { return d.source.y; })
    //     .attr("x2", function(d) { return d.target.x; })
    //     .attr("y2", function(d) { return d.target.y; });

    node
        .attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")"; });
  }

  //Toggle stores whether the highlighting is on
  var toggle = 0;

  //Create an array logging what is connected to what
  var linkedByIndex = {};
  for (i = 0; i < graph.nodes.length; i++) {
      linkedByIndex[i + "," + i] = 1;
  };
  graph.links.forEach(function (d) {
      linkedByIndex[d.source.index + "," + d.target.index] = 1;
  });

  //This function looks up whether a pair are neighbours
  function neighboring(a, b) {
      return linkedByIndex[a.index + "," + b.index];
  }

  function connectedNodes() {
    if (toggle == 0) {
        //Reduce the opacity of all but the neighbouring nodes
        d = d3.select(this).node().__data__;
        node.style("opacity", function (o) {
            return neighboring(d, o) | neighboring(o, d) ? 1 : 0.1;
        });

        // link.style("opacity", function (o) {
        //     return d.index==o.source.index | d.index==o.target.index ? 1 : 0.1;
        // });

        toggle = 1;
    } else {
        node.style("opacity", 1);
        // link.style("opacity", 1);
        toggle = 0;
    }
  }

  var optArray = [];
  for (var i = 0; i < graph.nodes.length - 1; i++) {
      optArray.push(graph.nodes[i].id);
  }
  optArray = optArray.sort();
  $(function () {
      $("#search").autocomplete({
          source: optArray
      });
  });
});

function searchNode() {
  var selectedVal = document.getElementById("search").value;
  var node = svg.selectAll(".node");
  if (selectedVal == "none") {
      node.style("stroke", "white").style("stroke-width", "1");
  } else {
      var selected = node.filter(function (d, i) {
          return d.id != selectedVal;
      });
      selected.style("opacity", "0");
      var link = svg.selectAll(".link")
      link.style("opacity", "0");
      d3.selectAll(".node, .links").transition()
          .duration(5000)
          .style("opacity", 1);
  }
}

function postData() {
  users = []
  var selected = d3.selectAll(".selected")._groups[0]
  selected.forEach(function(n){users.push(n.__data__.id)})
  d3.json("http://localhost:5000/feed", function(error, data) {
    if(data) console.log(data);
  })
  .header("Content-Type", "application/json")
  .send("POST", JSON.stringify(users));
}

</script>
